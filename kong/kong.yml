_format_version: "2.1"
_transform: true

services:
  # 1) Proxy Keycloak’s OIDC endpoints through Kong
  - name: keycloak-oidc
    url: http://keycloak:8080
    routes:
      - name: kc-token
        paths:
          - /realms/demo-realm/protocol/openid-connect/token
        strip_path: false
        preserve_host: false
        protocols:
          - http
      - name: kc-certs
        paths:
          - /realms/demo-realm/protocol/openid-connect/certs
        strip_path: false
        preserve_host: false
        protocols:
          - http

  # 2) Your Fiber app’s endpoints, explicitly listed
  - name: fiber-service
    url: http://app:3000
    routes:
      - name: public-route
        paths:
          - /public
        strip_path: false
        preserve_host: false
        protocols:
          - http
      - name: profile-route
        paths:
          - /profile
        strip_path: false
        preserve_host: false
        protocols:
          - http
      - name: user-route
        paths:
          - /user
        strip_path: false
        preserve_host: false
        protocols:
          - http
      - name: admin-route
        paths:
          - /admin
        strip_path: false
        preserve_host: false
        protocols:
          - http
    plugins:
      - name: jwt
        config:
          claims_to_verify:
            - exp
          key_claim_name: "preferred_username"

consumers:
  - username: kong-user
    custom_id: "realm-user"
  - username: kong-admin
    custom_id: "realm-admin"
